<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>An√°lise da Empresa | Saber Capital</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .grid-indicadores {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .indicador {
      background-color: #1e3a5f;
      padding: 1rem;
      border-radius: 6px;
      color: #fff;
    }
    .rating-gauge {
      max-width: 320px;
      margin: 2rem auto;
    }
    .diagnostico, .notas, .dd-analises {
      background-color: #1a365d;
      color: #fff;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1.5rem;
    }
    .dd-item {
      border-bottom: 1px solid #2c5282;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
    }
    .btn {
      margin-right: 0.5rem;
    }
    #nomeEmpresa {
      font-size: 1.6rem;
      text-align: center;
      margin-bottom: 0.5rem;
    }
    .status-badge {
      display: inline-block;
      padding: 0.3rem 0.75rem;
      border-radius: 999px;
      font-weight: bold;
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }
    .status-elegivel {
      background-color: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }
    .status-analise {
      background-color: rgba(251, 191, 36, 0.2);
      color: #facc15;
    }
    .status-negado {
      background-color: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }
    .log-ineficiencias {
  background-color: #1a365d;
  color: #fff;
  padding: 1rem;
  border-radius: 8px;
  margin-top: 1.5rem;
}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="logo-wrapper" onclick="window.location.href='index.html'" style="cursor:pointer;">
        <img src="logo bg removed.png" alt="Logo Saber Capital" class="logo-img" />
        <h1 class="logo-text">SABER<br>CAPITAL</h1>
      </div>

      <h2 class="subtitle" id="nomeEmpresa">An√°lise Financeira</h2>
      <div id="statusBadge" style="text-align:center;"></div>

      <div class="grid-indicadores" id="indicadores"></div>

      <div class="rating-gauge">
        <canvas id="gaugeChart"></canvas>
      </div>

      <div class="diagnostico" id="diagnostico"></div>

      <div class="notas">
        <h3>Notas</h3>
        <p id="notas"></p>
      </div>
      <div class="log-ineficiencias">
  <h3>Log de Inefici√™ncias</h3>
  <p id="logInef"></p>
</div>
      <div style="margin-top: 2rem;">
    <button class="btn" onclick="executarAvaliacaoIA()">Avaliar por IA</button>
    <button class="btn" onclick="enviarPara8n8()">Enviar para 8n8 (Exit Readiness)</button>
    <div id="resposta-exit" class="diagnostico" style="display: none; margin-top: 1rem;"></div>
    </div>
      
      <div id="resultado-ia" class="diagnostico" style="display: none;"></div>
      <div id="plano-acao" class="diagnostico" style="display: none;"></div>
            <div class="dd-analises">
              <h3>Due Diligence</h3>
              <div id="dd-analises"></div>
            </div>
            <div style="margin-top:2rem;">
        <button id="btnAddDD" class="btn">Adicionar Due Diligence</button>
        <button class="btn" id="btnVerInteligencia">Ver Intelig√™ncia</button>
        <br><br>
        <button class="btn" onclick="window.location.href='index.html'">‚Üê Voltar √† Lista</button>
        <button class="btn" onclick="comparar()">Comparar com outra empresa</button>
      </div>
    </div>
  </div>

  <script type="module">
    const idEmpresa = new URLSearchParams(window.location.search).get('id');
    document.querySelector('#btnAddDD').onclick = () => {
  window.location.href = `due_diligence.html?id=${idEmpresa}`;
};
 document.querySelector('#btnVerInteligencia').onclick = () => {
  window.location.href = `inteligencia.html?id=${idEmpresa}`;
};

    import { buscarEmpresas } from './airtable.js';

    const formatarMilhoes = v => v ? `R$ ${parseFloat(v).toFixed(1)} Milh√µes` : '-';
    const formatarPercentual = v => v ? `${(parseFloat(v) * 100).toFixed(1)}%` : '-';
    const formatarMultiplo = v => v ? `${parseFloat(v).toFixed(2)}x` : '-';

    const urlParams = new URLSearchParams(window.location.search);

    function comparar() {
      window.location.href = `comparar.html?id=${idEmpresa}`;
    }
    window.comparar = comparar;

    function gerarStatusBadge(rating) {
      if (rating >= 75)
        return `<span class="status-badge status-elegivel">Eleg√≠vel para investimento</span>`;
      if (rating >= 50)
        return `<span class="status-badge status-analise">Exige an√°lise complementar</span>`;
      return `<span class="status-badge status-negado">N√£o recomendado neste est√°gio</span>`;
    }

    function gerarAnalise(empresa) {
      const frases = [];

      if (empresa.crescimento_yoy >= 0.2)
        frases.push("apresenta crescimento expressivo ano a ano, refor√ßando sua trajet√≥ria de expans√£o sustent√°vel");
      else if (empresa.crescimento_yoy >= 0.05)
        frases.push("demonstra crescimento moderado e consistente");
      else if (empresa.crescimento_yoy < 0)
        frases.push("registra retra√ß√£o no crescimento, o que pode indicar desafios estruturais");

      if (empresa.margem_bruta >= 0.6)
        frases.push("mant√©m excelente margem bruta, evidenciando alta efici√™ncia operacional");
      else if (empresa.margem_bruta >= 0.4)
        frases.push("opera com boa margem bruta, com oportunidades de melhoria em custos diretos");
      else
        frases.push("enfrenta margens brutas comprimidas, exigindo revis√£o estrat√©gica da entrega de valor");

      if (empresa.sm >= 0.4)
        frases.push("apresenta gastos elevados com marketing e vendas (S&M), o que pode indicar depend√™ncia significativa de aquisi√ß√£o paga");

      if (empresa.sga >= 0.3)
        frases.push("registra despesas administrativas (SG&A) acima do ideal, sugerindo inefici√™ncias operacionais");

      if (empresa.ebitda > 0)
        frases.push("gera caixa operacional positivo, o que sustenta sua viabilidade no curto e m√©dio prazo");
      else
        frases.push("enfrenta desafios na gera√ß√£o de caixa, demandando maior controle sobre estrutura de custos");

      if (empresa.consistencia_yoy === "Crescimento positivo")
        frases.push("exibe consist√™ncia em sua evolu√ß√£o hist√≥rica, o que contribui para previsibilidade futura");
      else if (empresa.consistencia_yoy === "Decl√≠nio acentuado")
        frases.push("aponta um decl√≠nio recente preocupante no hist√≥rico de desempenho");

      return "A empresa " + frases.join(", ") + ".";
    }

async function carregarAnalisesDD(idEmpresa) {
  const url = `https://api.airtable.com/v0/appaq7tR3vt9vrN6y/Due%20Diligence?filterByFormula=ARRAYJOIN({EmpresaID}) = "${idEmpresa}"`;
  const res = await fetch(url, {
    headers: {
      Authorization: "Bearer patAOGNbJyOQrbHPB.22dd0a4309dc09867d31612922b5616a0a83965352599929e3566187a84607c6"
    }
  });
  const data = await res.json();

  const container = document.getElementById('dd-analises');
  if (data.records.length === 0) {
    container.innerHTML = '<p>Nenhuma an√°lise de due diligence registrada.</p>';
    return;
  }

  data.records.forEach(r => {
    const status = r.fields["Status da an√°lise"] ?? "-";
    const risco = r.fields["Classifica√ß√£o de risco"] ?? "-";
    const evidencia = r.fields["Evid√™ncia"]; // campo tipo URL simples

    let cor = "#ccc";
    if (risco === "Alto") cor = "#ef4444";
    else if (risco === "M√©dio") cor = "#facc15";
    else if (risco === "Baixo") cor = "#22c55e";

    const div = document.createElement('div');
    div.className = 'dd-item';
    div.innerHTML = `
      <p><strong>Tipo de dilig√™ncia:</strong> ${r.fields["Tipo de Diligencia"] ?? '-'}</p>
      <p><strong>Item analisado:</strong> ${r.fields["item analisado"] ?? '-'}</p>
      <p><strong>Status:</strong> ${status}
        <span class="badge-due" style="background-color:${cor}33; color:${cor}; padding: 0.2rem 0.5rem; border-radius: 999px; font-size: 0.8rem;">
          Risco: ${risco}
        </span>
      </p>
      ${r.fields["Comentarios"] ? `<p><strong>Coment√°rios:</strong> <em>${r.fields["Comentarios"]}</em></p>` : ''}
      ${evidencia ? `<a href="${evidencia}" target="_blank" class="btn-white-outline">Ver Evid√™ncia</a>` : ''}
    `;
    container.appendChild(div);
  });
}


    buscarEmpresas().then(empresas => {
      const empresa = empresas.find(e => e.id === idEmpresa);
      if (!empresa) return;

      const rating = empresa.rating ?? 0;

      document.getElementById('nomeEmpresa').textContent = empresa.nome;
      document.getElementById('statusBadge').innerHTML = gerarStatusBadge(rating);

      const campos = [
        { label: 'Receita Anual', valor: formatarMilhoes(empresa.receita) },
        { label: 'EBITDA', valor: formatarMilhoes(empresa.ebitda) },
        { label: 'Valuation', valor: formatarMilhoes(empresa.valuation) },
        { label: 'Margem EBITDA', valor: formatarPercentual(empresa.margem_ebitda) },
        { label: 'EV/EBITDA', valor: formatarMultiplo(empresa.ev_ebitda) },
        { label: 'Crescimento YoY', valor: formatarPercentual(empresa.crescimento_yoy) },
        { label: 'Margem Bruta', valor: formatarPercentual(empresa.margem_bruta) },
        { label: 'S&M', valor: formatarPercentual(empresa.sm) },
        { label: 'SG&A', valor: formatarPercentual(empresa.sga) },
        { label: 'Consist√™ncia Crescimento YoY', valor: empresa.consistencia_yoy ?? '-' }
      ];

      const grid = document.getElementById('indicadores');
      campos.forEach(c => {
        const div = document.createElement('div');
        div.className = 'indicador';
        div.innerHTML = `<strong>${c.label}</strong><br>${c.valor}`;
        grid.appendChild(div);
      });

      document.getElementById('diagnostico').textContent = gerarAnalise(empresa);
      document.getElementById('notas').textContent = empresa.notas || 'Nenhuma nota registrada.';
      document.getElementById('logInef').textContent = empresa["Log de Inefici√™ncias"] || 'Nenhum log de inefici√™ncia registrado.';

      new Chart(document.getElementById('gaugeChart'), {
        type: 'doughnut',
        data: {
          labels: ['Rating'],
          datasets: [{
            data: [rating, 100 - rating],
            backgroundColor: ['#3b82f6', '#1e293b'],
            borderWidth: 0
          }]
        },
        options: {
          rotation: -90,
          circumference: 180,
          cutout: '70%',
          plugins: {
            legend: { display: false },
            tooltip: { enabled: false },
            title: {
              display: true,
              text: `${rating} / 100`,
              color: '#fff',
              font: { size: 24, weight: 'bold' },
              padding: 10
            }
          }
        }
      });

      carregarAnalisesDD(idEmpresa);
      window.empresaSelecionada = empresa;
    });
    async function buscarDiligenciasCriticas(empresaId) {
  const baseId = 'appaq7tR3vt9vrN6y';
  const tableDD = 'Due%20Diligence';
  const apiKey = 'patAOGNbJyOQrbHPB.22dd0a4309dc09867d31612922b5616a0a83965352599929e3566187a84607c6';

  const headers = { Authorization: `Bearer ${apiKey}` };
  const url = `https://api.airtable.com/v0/${baseId}/${tableDD}?filterByFormula={EmpresaID} = "${empresaId}"`;
  const res = await fetch(url, { headers });
  const data = await res.json();

  const registros = data.records;

  const criticas = registros.filter(reg => {
    const risco = reg.fields["Classifica√ß√£o de risco"];
    const status = reg.fields["Status da an√°lise"];
    return (
      (risco === 'Alto' || risco === 'M√©dio') &&
      ['Pendente', 'Atrasado', 'Incompleto'].includes(status)
    );
  });

  return criticas.length;
}

async function atualizarRiscoIA(id, riscoIA) {
  const baseId = 'appaq7tR3vt9vrN6y';
  const table = 'Empresas';
  const apiKey = 'patAOGNbJyOQrbHPB.22dd0a4309dc09867d31612922b5616a0a83965352599929e3566187a84607c6';

  const url = `https://api.airtable.com/v0/${baseId}/${table}/${id}`;
  const res = await fetch(url, {
    method: 'PATCH',
    headers: {
      Authorization: `Bearer ${apiKey}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      fields: { "Risco IA": riscoIA }
    })
  });

  if (!res.ok) {
    console.error('Erro ao atualizar risco IA:', await res.text());
  }
}
async function registrarHistoricoIA(empresa, risco, alertas) {
  const baseId = 'appaq7tR3vt9vrN6y';
  const table = 'Hist√≥rico IA';
  const apiKey = 'patAOGNbJyOQrbHPB.22dd0a4309dc09867d31612922b5616a0a83965352599929e3566187a84607c6';

  const timestamp = new Date().toISOString();
  const justificativas = alertas.map((item, i) => `(${i + 1}) ${item}`).join('\n');

  const metodo = "An√°lise gerada por l√≥gica automatizada interna (JavaScript) com base em KPIs e status de Due Diligence.";

  const areas = [];
  if (alertas.some(a => a.includes("SG&A"))) areas.push("Financeiro");
  if (alertas.some(a => a.includes("S&M"))) areas.push("Marketing");
  if (alertas.some(a => a.includes("Valuation"))) areas.push("Estrat√©gia");
  if (alertas.some(a => a.includes("Dilig√™ncias"))) areas.push("Compliance");
  if (alertas.some(a => a.includes("Margem"))) areas.push("Opera√ß√µes");
  if (alertas.some(a => a.includes("Crescimento"))) areas.push("Crescimento");

  const url = `https://api.airtable.com/v0/${baseId}/${encodeURIComponent(table)}`;
  const res = await fetch(url, {
    method: 'POST',
    headers: {
      Authorization: `Bearer ${apiKey}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      fields: {
        "EmpresaID": empresa.id,
        "Empresa": empresa.nome,
        "Risco IA": risco,
        "Justificativas": justificativas,
        "Data da Avalia√ß√£o": timestamp,
        "Prompt": metodo,
        "√Åreas Cr√≠ticas": areas.join(', ')
      }
    })
  });

  if (!res.ok) {
    console.error('Erro ao registrar hist√≥rico IA:', await res.text());
  }
}
function gerarPlanoAcao(alertas) {
  if (!alertas || alertas.length === 0) return "Nenhum problema cr√≠tico identificado. A empresa apresenta um perfil financeiro saud√°vel.";

  const solucoes = [];

  alertas.forEach(alerta => {
    if (alerta.includes("EBITDA negativo"))
      solucoes.push("Revisar estrutura de custos e buscar fontes de receita mais previs√≠veis para reverter o EBITDA negativo.");
    if (alerta.includes("Margem EBITDA"))
      solucoes.push("Reduzir custos operacionais ou aumentar pre√ßo m√©dio para melhorar a margem EBITDA.");
    if (alerta.includes("EV/EBITDA"))
      solucoes.push("Avaliar estrat√©gias para melhorar gera√ß√£o de caixa e justificar o valuation atual.");
    if (alerta.includes("SG&A"))
      solucoes.push("Revisar gastos administrativos e implementar controle mais r√≠gido de despesas fixas.");
    if (alerta.includes("S&M"))
      solucoes.push("Avaliar o ROI das campanhas de marketing e otimizar canais de aquisi√ß√£o.");
    if (alerta.includes("Margem bruta"))
      solucoes.push("Negociar melhores contratos com fornecedores ou otimizar a cadeia produtiva.");
    if (alerta.includes("Crescimento YoY"))
      solucoes.push("Identificar produtos/segmentos com melhor desempenho e investir no crescimento org√¢nico.");
    if (alerta.includes("Consist√™ncia hist√≥rica"))
      solucoes.push("Estabilizar resultados com foco em previsibilidade e gest√£o por indicadores.");
    if (alerta.includes("Valuation maior"))
      solucoes.push("Ajustar expectativas de crescimento e comunicar melhor o racional de valuation ao mercado.");
    if (alerta.includes("Dilig√™ncias pendentes"))
      solucoes.push("Concluir as dilig√™ncias cr√≠ticas com aten√ß√£o √†s √°reas apontadas como risco m√©dio ou alto.");
  });

  // Remover duplicadas e montar par√°grafo
  const planoFinal = [...new Set(solucoes)];
  return planoFinal.map((item, i) => `${i + 1}. ${item}`).join('<br>');
}

async function executarAvaliacaoIA() {
  const empresa = window.empresaSelecionada;
  const alertas = [];
  let risco = 'Baixo';

  if (empresa.ebitda <= 0)
    alertas.push("EBITDA negativo, risco de gera√ß√£o de caixa");

  if (empresa.margem_ebitda < 0.1)
    alertas.push("Margem EBITDA abaixo de 10%");

  if (empresa.ev_ebitda > 20)
    alertas.push("EV/EBITDA elevado (>20)");

  if (empresa.sga > 0.3)
    alertas.push("SG&A elevado (>30%)");

  if (empresa.sm > 0.4)
    alertas.push("S&M elevado (>40%)");

  if (empresa.margem_bruta < 0.4)
    alertas.push("Margem bruta baixa (<40%)");

  if (empresa.crescimento_yoy < 0)
    alertas.push("Crescimento YoY negativo");

  if (empresa.consistencia_yoy === "Decl√≠nio acentuado")
    alertas.push("Consist√™ncia hist√≥rica ruim");

  if (empresa.valuation > 10 * empresa.receita)
    alertas.push("Valuation maior que 10x receita");

  const qtdCriticas = await buscarDiligenciasCriticas(empresa.id);
  if (qtdCriticas >= 1)
    alertas.push("Dilig√™ncias pendentes ou atrasadas com risco m√©dio/alto");

  if (alertas.length >= 5) risco = 'Alto';
  else if (alertas.length >= 2) risco = 'M√©dio';

  const cor = risco === 'Alto' ? '#ef4444' : risco === 'M√©dio' ? '#facc15' : '#22c55e';

  const resultadoDiv = document.getElementById('resultado-ia');
  resultadoDiv.style.display = 'block';
  resultadoDiv.innerHTML = `
    <h3 style="margin-top: 0;">üß† Avalia√ß√£o de Risco por IA Interna</h3>
    <p><strong>Classifica√ß√£o:</strong> <span style="color: ${cor}; font-weight: bold;">${risco}</span></p>
    <p><strong>Justificativas:</strong><br>${alertas.join('<br>')}</p>
  `;
const planoDiv = document.getElementById('plano-acao');
planoDiv.style.display = 'block';
planoDiv.innerHTML = `
  <h3 style="margin-top: 0;">Plano de A√ß√£o Sugerido</h3>
  <p>${gerarPlanoAcao(alertas)}</p>
`;

  await atualizarRiscoIA(empresa.id, risco);
  const textoLog = `Diagn√≥stico de Inefici√™ncias ‚Äì Classifica√ß√£o: ${risco}
Justificativas detectadas:
${alertas.map((item, i) => `(${i + 1}) ${item}`).join('\n')}
`;

await atualizarLogInef(empresa.id, textoLog);
  document.getElementById('logInef').textContent = textoLog;


  await registrarHistoricoIA(empresa, risco, alertas);
}
async function atualizarLogInef(empresaId, texto) {
  const baseId = 'appaq7tR3vt9vrN6y';
  const table = 'Empresas';
  const apiKey = 'patAOGNbJyOQrbHPB.22dd0a4309dc09867d31612922b5616a0a83965352599929e3566187a84607c6';

  const url = `https://api.airtable.com/v0/${baseId}/${table}/${empresaId}`;
  const res = await fetch(url, {
    method: 'PATCH',
    headers: {
      Authorization: `Bearer ${apiKey}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      fields: {
        "Log de Inefici√™ncias": texto
      }
    })
  });

  if (!res.ok) {
    console.error('Erro ao atualizar Log de Inefici√™ncias:', await res.text());
  }
}
async function enviarPara8n8() {
  const empresa = window.empresaSelecionada;
  const payload = {
    empresa: empresa.nome,
    receita: empresa.receita,
    ebitda: empresa.ebitda,
    ev_ebitda: empresa.ev_ebitda,
    margem_ebitda: empresa.margem_ebitda,
    risco_ia: empresa["Risco IA"] || "N√£o avaliado"
  };

  try {
    const resposta = await fetch("https://n8n.isilab.com.br/webhook-test/b90de8b7-caf3-44f0-a48f-a03ee5cd4f99", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await resposta.json();

    document.getElementById('resposta-exit').style.display = 'block';
    const respostaJson = await resposta.json();
document.getElementById('resposta-exit').innerHTML = `
  <h3>üì§ Valida√ß√£o de Exit Readiness</h3>
  <p>${respostaJson.analise_exit || "Nenhuma an√°lise retornada."}</p>
`;

  } catch (error) {
    console.error("Erro ao enviar para 8n8:", error);
    document.getElementById('resposta-exit').innerHTML = `<p style="color:red;">Erro ao processar a an√°lise. Tente novamente mais tarde.</p>`;
  }
}

window.enviarPara8n8 = enviarPara8n8;
window.executarAvaliacaoIA = executarAvaliacaoIA;
  </script>
</body>
</html>
