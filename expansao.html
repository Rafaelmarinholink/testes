<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Análise de Expansão | Saber Capital</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="logo-wrapper" onclick="window.location.href='index.html'" style="cursor:pointer;">
        <img src="logo bg removed.png" alt="Logo Saber Capital" class="logo-img"/>
        <h1 class="logo-text">SABER<br>CAPITAL</h1>
      </div>

      <h2 class="subtitle" id="titulo">Análise de Expansão</h2>

      <div style="text-align: center; margin-top: 2rem;">
        <button class="btn" onclick="simularCenarios()">Simular Cenários com IA</button>
      </div>

      <div style="text-align: center; margin-top: 2rem;">
        <button class="btn" onclick="voltarParaEmpresa()">← Voltar à Análise da Empresa</button>
      </div>

      <div class="diagnostico" id="resultadoIA" style="display:none; margin-top:2rem;"></div>
    </div>
  </div>

 <script type="module">
  import { buscarEmpresas } from './airtable.js';

  const urlParams = new URLSearchParams(window.location.search);
  const idEmpresa = urlParams.get('id');
  let empresaAtual = null;

  document.getElementById('titulo').textContent = "Análise de Expansão – carregando...";

  buscarEmpresas().then(empresas => {
    empresaAtual = empresas.find(e => e.id === idEmpresa);
    if (empresaAtual) {
      document.getElementById('titulo').textContent = `Análise de Expansão – ${empresaAtual.nome}`;
    }
  });

  window.voltarParaEmpresa = () => {
    window.location.href = `empresa.html?id=${idEmpresa}`;
  };

  window.simularCenarios = async () => {
    if (!empresaAtual) return alert("Empresa não encontrada.");

    const payload = {
      nome: empresaAtual.nome,
      receita: empresaAtual.receita,
      ebitda: empresaAtual.ebitda,
      ev_ebitda: empresaAtual.ev_ebitda,
      margem_ebitda: empresaAtual.margem_ebitda,
      crescimento_yoy: empresaAtual.crescimento_yoy,
      margem_bruta: empresaAtual.margem_bruta,
      sm: empresaAtual.sm,
      sga: empresaAtual.sga
    };

    try {
      const resposta = await fetch("https://n8n.isilab.com.br/webhook-test/6def0157-da67-4eb6-bedf-80879d2aea85", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

       const texto = await resposta.text();

    document.getElementById('resultadoIA').style.display = 'block';
    document.getElementById('resultadoIA').innerHTML = `
      <h3>Cenários de expansão</h3>
      <p style="white-space:pre-wrap;">${texto}</p>
    `;
  } catch (error) {
    console.error("Erro ao enviar para 8n8:", error);
    document.getElementById('cenarios').innerHTML = `<p style="color:red;">Erro ao processar a análise. Tente novamente mais tarde.</p>`;
  }
}
</script>
</body>
</html>
