<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Comparar Empresas | Saber Capital</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .comparacao-container {
      display: flex;
      gap: 2rem;
      flex-wrap: wrap;
      margin-top: 2rem;
    }
    .empresa-card {
      background-color: #1a365d;
      padding: 1.5rem;
      border-radius: 8px;
      color: white;
      flex: 1 1 45%;
    }
    .grid-kpis {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    .kpi {
      background-color: #102c4c;
      padding: 0.5rem;
      border-radius: 5px;
    }
    .actions {
      margin-top: 2rem;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .search-box {
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="logo-wrapper" onclick="window.location.href='index.html'" style="cursor:pointer;">
        <img src="logo bg removed.png" alt="Logo Saber Capital" class="logo-img" />
        <h1 class="logo-text">SABER<br>CAPITAL</h1>
      </div>

      <h2 class="subtitle">Comparação Entre Empresas</h2>

      <div id="selecionarEmpresa2" class="search-box">
        <label for="empresa2">Selecione a segunda empresa para comparar:</label>
        <input type="text" id="empresa2" placeholder="Digite o nome da empresa..." />
        <ul id="listaSugestoes"></ul>
      </div>

      <div class="comparacao-container" id="comparacao"></div>

      <div class="actions" id="botoesAcao" style="display:none;">
        <button class="btn" onclick="novaComparacao()">Nova Comparação</button>
        <button class="btn" onclick="inverterEmpresas()">Inverter Empresas</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { buscarEmpresas } from './airtable.js';

    const urlParams = new URLSearchParams(window.location.search);
    let empresa1Id = urlParams.get('id');
    let empresa2Id = null;
    let empresas = [];

    let empresa1 = null;
    let empresa2 = null;

    const comparacao = document.getElementById('comparacao');
    const listaSugestoes = document.getElementById('listaSugestoes');
    const inputEmpresa2 = document.getElementById('empresa2');

    function formatarValor(v, tipo = '') {
      if (v === undefined || v === null || v === '') return '-';
      if (tipo === 'milhoes') return `R$ ${Number(v).toLocaleString('pt-BR')} Milhões`;
      if (tipo === 'percentual') return `${(v * 100).toFixed(1)}%`;
      if (tipo === 'multiplo') return `${Number(v).toFixed(2)}x`;
      return v;
    }

    function criarCard(empresa, titulo) {
      return `
        <div class="empresa-card">
          <h3>${titulo}</h3>
          <div class="grid-kpis">
            <div class="kpi"><strong>Nome:</strong> ${empresa.nome}</div>
            <div class="kpi"><strong>Rating:</strong> ${empresa.rating ?? '-'}</div>
            <div class="kpi"><strong>Receita:</strong> ${formatarValor(empresa.receita, 'milhoes')}</div>
            <div class="kpi"><strong>EBITDA:</strong> ${formatarValor(empresa.ebitda, 'milhoes')}</div>
            <div class="kpi"><strong>Valuation:</strong> ${formatarValor(empresa.valuation, 'milhoes')}</div>
            <div class="kpi"><strong>Margem EBITDA:</strong> ${formatarValor(empresa.margem_ebitda, 'percentual')}</div>
            <div class="kpi"><strong>EV/EBITDA:</strong> ${formatarValor(empresa.ev_ebitda, 'multiplo')}</div>
            <div class="kpi"><strong>Crescimento YoY:</strong> ${formatarValor(empresa.crescimento_yoy, 'percentual')}</div>
            <div class="kpi"><strong>Margem Bruta:</strong> ${formatarValor(empresa.margem_bruta, 'percentual')}</div>
            <div class="kpi"><strong>S&M:</strong> ${formatarValor(empresa.sm, 'percentual')}</div>
            <div class="kpi"><strong>SG&A:</strong> ${formatarValor(empresa.sga, 'percentual')}</div>
            <div class="kpi"><strong>Consistência Crescimento:</strong> ${empresa.consistencia_yoy ?? '-'}</div>
          </div>
        </div>
      `;
    }

    function renderizarComparacao() {
      comparacao.innerHTML = '';
      comparacao.innerHTML += criarCard(empresa1, "Empresa 1");
      comparacao.innerHTML += criarCard(empresa2, "Empresa 2");
      document.getElementById('botoesAcao').style.display = 'flex';
      document.getElementById('selecionarEmpresa2').style.display = 'none';
    }

    function novaComparacao() {
      window.location.href = `comparar.html?id=${empresa1Id}`;
    }

    function inverterEmpresas() {
      window.location.href = `comparar.html?id=${empresa2Id}`;
    }

    inputEmpresa2.addEventListener('input', () => {
      const texto = inputEmpresa2.value.toLowerCase();
      const sugestoes = empresas.filter(emp => emp.id !== empresa1Id && emp.nome.toLowerCase().includes(texto));

      listaSugestoes.innerHTML = '';
      sugestoes.forEach(emp => {
        const li = document.createElement('li');
        li.textContent = emp.nome;
        li.style.cursor = 'pointer';
        li.style.padding = '0.4rem';
        li.style.color = '#fff';
        li.addEventListener('click', () => {
          empresa2Id = emp.id;
          empresa2 = emp;
          renderizarComparacao();
        });
        listaSugestoes.appendChild(li);
      });
    });

    buscarEmpresas().then(res => {
      empresas = res;
      empresa1 = empresas.find(e => e.id === empresa1Id);
    });
  </script>
</body>
</html>